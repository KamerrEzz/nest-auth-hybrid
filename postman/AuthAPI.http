# Auth API - HTTP Requests (para REST Client / VS Code)
# Documenta cada endpoint, lo que envía y lo que valida/retorna.
# Basado en: d:\CODE\learning\DDDD\auth-api\postman\AuthAPI.postman_collection.json

@baseUrl = http://localhost:3000
@email = user@example.com
@password = Password123!
@otpCode = 123456
@totpCode = 
@accessToken = 
@refreshToken = 
@csrfToken = 
@sessionId = 
@tempToken = 
@sessionToRevoke = 

### CSRF: obtiene y setea cookie csrfToken
GET {{baseUrl}}/auth/csrf

# Cabeceras relevantes: Set-Cookie -> csrfToken=... (no HttpOnly)
# Uso: copiar el valor de csrfToken de la respuesta y usarlo en X-CSRF-Token y Cookie

### Registro: crea usuario y sesión inicial
POST {{baseUrl}}/auth/register
Content-Type: application/json
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}

{
  "email": "{{email}}",
  "password": "{{password}}",
  "name": "Demo"
}

# Valida: formato email, password, rate-limit y CSRF
# Retorna: user, accessToken, refreshToken; Set-Cookie: sessionId, csrfToken

### Login sin 2FA: credenciales válidas -> tokens + cookie sesión
POST {{baseUrl}}/auth/login
Content-Type: application/json
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}

{
  "email": "{{email}}",
  "password": "{{password}}"
}

# Valida: credenciales, CSRF, throttling
# Retorna: accessToken, refreshToken, user; Set-Cookie: sessionId, csrfToken

### Login con 2FA: requiere OTP/TOTP
POST {{baseUrl}}/auth/login
Content-Type: application/json
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}

{
  "email": "{{email}}",
  "password": "{{password}}"
}

# Retorna: { "requiresOtp": true, "tempToken": "..." }
# tempToken: ticket temporal, un uso, con expiración; relaciona intento de login con verificación OTP/TOTP

### Verificar OTP/TOTP: completa login 2FA
POST {{baseUrl}}/auth/verify-otp
Content-Type: application/json
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}

{
  "tempToken": "{{tempToken}}",
  "otpCode": "{{otpCode}}",
  "totpCode": "{{totpCode}}"
}

# Valida: existe tempToken, otpCode o totpCode válido, CSRF
# Retorna: accessToken, refreshToken, user; Set-Cookie: sessionId, csrfToken

### Refresh Token: emite nuevo access token
POST {{baseUrl}}/auth/refresh
Content-Type: application/json
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

{
  "refreshToken": "{{refreshToken}}"
}

# Valida: refreshToken vigente, CSRF y sesión
# Retorna: accessToken

### Me (JWT): datos del usuario autenticado
GET {{baseUrl}}/auth/me
Authorization: Bearer {{accessToken}}

# Valida: token JWT; retorna DTO de usuario

### Me (Cookie): datos del usuario por cookie de sesión
GET {{baseUrl}}/auth/me
Cookie: sessionId={{sessionId}}

# Valida: cookie sesión; retorna DTO de usuario

### Logout: limpiar sesión actual
POST {{baseUrl}}/auth/logout
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

# Valida: CSRF; retorna { ok: true }; limpia cookie sessionId

### 2FA - Enable: inicia proceso de habilitar 2FA
POST {{baseUrl}}/auth/enable-2fa
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

# No envía body; requiere sesión válida.
# Valida: sesión; prepara TOTP.
# Retorna:
# {
#   "qrCode": "data:image/png;base64,....",
#   "secret": "BASE32SECRET"
# }
# qrCode: Data URL para renderizar el QR.
# secret: clave BASE32 para apps TOTP (Google Auth/Authy/etc.).

### 2FA - Verify: confirma TOTP
POST {{baseUrl}}/auth/verify-2fa
Content-Type: application/json
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

{
  "code": "{{totpCode}}"
}

# Valida: código TOTP válido contra el secreto del usuario.
# Efecto: marca 2FA confirmado (has2FA=true) y genera backup codes.
# Retorna:
# {
#   "ok": true,
#   "backupCodes": ["abcd1234", "..."]
# }

### 2FA - Status: estado actual del 2FA del usuario
GET {{baseUrl}}/auth/2fa/status
Cookie: sessionId={{sessionId}}

# Retorna: { enabled: boolean, hasSecret: boolean, backupCount: number }

### 2FA - Disable: deshabilita 2FA usando TOTP o backup code
POST {{baseUrl}}/auth/disable-2fa
Content-Type: application/json
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

{
  "totpCode": "{{totpCode}}",
  "backupCode": ""
}

# Valida: uno de los códigos; limpia estado 2FA

### 2FA - Cancel: cancela proceso si aún no está confirmado
POST {{baseUrl}}/auth/2fa/cancel
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

# Retorna: ok; sólo si no está confirmado aún

### Sesiones - Listar
GET {{baseUrl}}/auth/sessions
Cookie: sessionId={{sessionId}}

# Retorna: array de sesiones con { id, ipAddress, userAgent, lastActive }

### Sesiones - Revocar todas
DELETE {{baseUrl}}/auth/sessions
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

# Retorna: { ok: true }

### Sesiones - Revocar una por id
DELETE {{baseUrl}}/auth/sessions/{{sessionToRevoke}}
X-CSRF-Token: {{csrfToken}}
Cookie: csrfToken={{csrfToken}}; sessionId={{sessionId}}

# Retorna: { ok: true }

### OAuth - Google (inicio)
GET {{baseUrl}}/auth/google

# Flujo web: redirige a Google; requiere navegador

### OAuth - Google (callback)
GET {{baseUrl}}/auth/google/callback

# Flujo web: tras OAuth, backend puede retornar tokens o requiresOtp + tempToken
# Si el usuario tiene 2FA -> { requiresOtp: true, tempToken }

### OAuth - Discord (inicio)
GET {{baseUrl}}/auth/discord

# Flujo web: redirige a Discord; requiere navegador

### OAuth - Discord (callback)
GET {{baseUrl}}/auth/discord/callback

# Flujo web: tras OAuth, backend puede retornar tokens o requiresOtp + tempToken