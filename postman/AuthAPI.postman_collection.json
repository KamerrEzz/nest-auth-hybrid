{
  "info": {
    "name": "Auth API - NestJS",
    "_postman_id": "b3a7c1f4-8a7e-4b09-9b2e-9d03d0a1f001",
    "description": "Colección para probar autenticación híbrida, OTP y 2FA/TOTP",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:3000" },
    { "key": "email", "value": "user@example.com" },
    { "key": "password", "value": "Password123!" },
    { "key": "otpCode", "value": "123456" },
    { "key": "totpCode", "value": "" },
    { "key": "accessToken", "value": "" },
    { "key": "refreshToken", "value": "" },
    { "key": "csrfToken", "value": "" },
    { "key": "sessionId", "value": "" },
    { "key": "tempToken", "value": "" }
  ],
  "item": [
    {
      "name": "GET /auth/csrf",
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/auth/csrf"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const body = pm.response.json();",
              "if (body.csrfToken) pm.environment.set('csrfToken', body.csrfToken);",
              "const setCookie = pm.response.headers.get('Set-Cookie') || '';",
              "const csrfMatch = setCookie.match(/csrfToken=([^;]+)/);",
              "if (csrfMatch) pm.environment.set('csrfToken', csrfMatch[1]);"
            ]
          }
        }
      ]
    },
    {
      "name": "POST /auth/register",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"email\":\"{{email}}\",\"password\":\"{{password}}\",\"name\":\"Demo\"}"
        },
        "url": "{{baseUrl}}/auth/register"
      }
    },
    {
      "name": "POST /auth/login (sin 2FA)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"email\":\"{{email}}\",\"password\":\"{{password}}\"}"
        },
        "url": "{{baseUrl}}/auth/login"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const res = pm.response.json();",
              "if (res.accessToken) pm.environment.set('accessToken', res.accessToken);",
              "if (res.refreshToken) pm.environment.set('refreshToken', res.refreshToken);",
              "if (res.csrfToken) pm.environment.set('csrfToken', res.csrfToken);",
              "const setCookie = pm.response.headers.get('Set-Cookie') || '';",
              "const sidMatch = setCookie.match(/sessionId=([^;]+)/);",
              "if (sidMatch) pm.environment.set('sessionId', sidMatch[1]);",
              "const csrfMatch = setCookie.match(/csrfToken=([^;]+)/);",
              "if (csrfMatch) pm.environment.set('csrfToken', csrfMatch[1]);"
            ]
          }
        }
      ]
    },
    {
      "name": "POST /auth/login (con 2FA → OTP)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"email\":\"{{email}}\",\"password\":\"{{password}}\"}"
        },
        "url": "{{baseUrl}}/auth/login"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const res = pm.response.json();",
              "if (res.tempToken) pm.environment.set('tempToken', res.tempToken);",
              "pm.test('requiresOtp debe ser true', function(){ pm.expect(res.requiresOtp).to.eql(true); });"
            ]
          }
        }
      ]
    },
    {
      "name": "POST /auth/verify-otp",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"tempToken\":\"{{tempToken}}\",\"otpCode\":\"{{otpCode}}\",\"totpCode\":\"{{totpCode}}\"}"
        },
        "url": "{{baseUrl}}/auth/verify-otp"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const res = pm.response.json();",
              "if (res.accessToken) pm.environment.set('accessToken', res.accessToken);",
              "if (res.refreshToken) pm.environment.set('refreshToken', res.refreshToken);",
              "if (res.csrfToken) pm.environment.set('csrfToken', res.csrfToken);",
              "const setCookie = pm.response.headers.get('Set-Cookie') || '';",
              "const sidMatch = setCookie.match(/sessionId=([^;]+)/);",
              "if (sidMatch) pm.environment.set('sessionId', sidMatch[1]);",
              "const csrfMatch = setCookie.match(/csrfToken=([^;]+)/);",
              "if (csrfMatch) pm.environment.set('csrfToken', csrfMatch[1]);"
            ]
          }
        }
      ]
    },
    {
      "name": "POST /auth/refresh",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}; sessionId={{sessionId}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"refreshToken\":\"{{refreshToken}}\"}"
        },
        "url": "{{baseUrl}}/auth/refresh"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "const res = pm.response.json();",
              "if (res.accessToken) pm.environment.set('accessToken', res.accessToken);"
            ]
          }
        }
      ]
    },
    {
      "name": "GET /auth/me (JWT)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{accessToken}}" }
        ],
        "url": "{{baseUrl}}/auth/me"
      }
    },
    {
      "name": "GET /auth/me (Cookie)",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Cookie", "value": "sessionId={{sessionId}}" }
        ],
        "url": "{{baseUrl}}/auth/me"
      }
    },
    {
      "name": "POST /auth/logout",
      "request": {
        "method": "POST",
        "header": [
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}; sessionId={{sessionId}}" }
        ],
        "url": "{{baseUrl}}/auth/logout"
      }
    },
    {
      "name": "POST /auth/enable-2fa",
      "request": {
        "method": "POST",
        "header": [
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}; sessionId={{sessionId}}" }
        ],
        "url": "{{baseUrl}}/auth/enable-2fa"
      }
    },
    {
      "name": "POST /auth/verify-2fa",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}; sessionId={{sessionId}}" }
        ],
        "body": { "mode": "raw", "raw": "{\"code\":\"{{totpCode}}\"}" },
        "url": "{{baseUrl}}/auth/verify-2fa"
      }
    },
    {
      "name": "POST /auth/disable-2fa",
      "request": {
        "method": "POST",
        "header": [
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}; sessionId={{sessionId}}" }
        ],
        "url": "{{baseUrl}}/auth/disable-2fa"
      }
    },
    {
      "name": "GET /auth/sessions",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Cookie", "value": "sessionId={{sessionId}}" }
        ],
        "url": "{{baseUrl}}/auth/sessions"
      }
    },
    {
      "name": "DELETE /auth/sessions/:id",
      "request": {
        "method": "DELETE",
        "header": [
          { "key": "X-CSRF-Token", "value": "{{csrfToken}}" },
          { "key": "Cookie", "value": "csrfToken={{csrfToken}}; sessionId={{sessionId}}" }
        ],
        "url": {
          "raw": "{{baseUrl}}/auth/sessions/{{sessionToRevoke}}",
          "host": ["{{baseUrl}}"],
          "path": ["auth","sessions","{{sessionToRevoke}}"]
        }
      }
    }
  ]
}